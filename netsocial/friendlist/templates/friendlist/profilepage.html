<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <link rel="stylesheet" href="../../static/css/profile.css" />
  </head>
  <body>
    <nav>
      <ul>
        {% if request.user.is_authenticated %}
        <li><a class="active" href="{% url 'logout' %}">Logout</a></li>
        <li><a href="{% url 'chat_box' %}">Chatbox</a></li>
        <li><a href="{% url 'friend_page_view' %}">Friends</a></li>
        {% endif %}
        <li><a href="{% url 'home' %}">Home</a></li>
      </ul>
    </nav>

    <div class="outer-container">
      <div class="main-container">
        <div class="card">
          <img
            src="https://i.pinimg.com/736x/a8/57/00/a85700f3c614f6313750b9d8196c08f5.jpg"
            alt="profile-picture"
            style="width: 70%"
          />
          {% if user == request.user %}
          <button id="editButton">Edit</button>
          {% endif %}

          {% if user != request.user %}
          <form action="{% url 'send_friend_request' user.id %}" method="post">
            {% csrf_token %}
            <div>
              <button id="friendRequest" value="Send Friend Request">Send friend Request</button>
            </div>
          </form>
          {% endif %}
        </div>

        <form method="post" id="profileForm">
          {% csrf_token %}
          <div class="inner-container">
            <div>
              <label for="name"><h1>Name</h1></label>
              <input
                type="text"
                placeholder="Enter Name"
                name="username"
                id="usernameInput"
                value="{{ user.username }}"
                required
                disabled
              />
            </div>

            <div>
              <label for="email"><h2>Email</h2></label>
              <input
                type="email"
                placeholder="Enter Email"
                name="email"
                id="emailInput"
                value="{{ user.email }}"
                required
                disabled
              />
            </div>

            <div>
              <label for="bio"><h2>Bio</h2></label>
              <input
                type="text"
                placeholder="Enter Bio"
                name="bio"
                id="bioInput"
                value="{{ user_profile.bio }}"
                required
                disabled
              />
            </div>

            <div>
              <label for="birthday"><h2>Birthday</h2></label>
              <input
                type="date"
                placeholder="Enter Birthday"
                name="birthday"
                id="birthdayInput"
                value="{{ user_profile.birthday }}"
                required
                disabled
              />
            </div>
          </div>
          <button type="button" id="saveButton" style="display: none;">Save</button>
        </form>

        
        <!-- Show existing posts -->
        <div class="feed-container">
                    <div class="post-container">

          {% for post in user_posts %}
          <div class="post">
            <p>{{ post.content }}</p>
            <!-- Add timestamp if available -->
            {% if post.timestamp %}
            <p>Posted on {{ post.timestamp }}</p>
            {% endif %}
          </div>
          {% endfor %}
          </div>
          <!-- Add a section for posting new content -->

        <div class="submit-container">
          <form method="post" id="newPostForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input name="content" placeholder="Write something..." required>
            <input type="file" name="image" accept="image/*"> 
            <button type="submit">Post</button>
          </form>
        </div>
        </div>
      </div>
    </div>
    <script>
      // JavaScript code for handling post form submission
      document.getElementById('newPostForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission
        const formData = new FormData(this); // Get form data

        // Send a POST request to create a new post
        fetch("{% url 'create_post' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}', // Include the CSRF token
          },
        })
          .then((response) => response.json())
          .then((data) => {
            // Handle the response data, e.g., show the new post
            const feedContainer = document.querySelector('.feed-container');
            const newPost = document.createElement('div');
            newPost.className = 'post';
            newPost.innerHTML = `<p>${data.content}</p>`;
            if (data.image_url) {
              newPost.innerHTML += `<img src="${data.image_url}" alt="post-image">`;
            }
            feedContainer.appendChild(newPost);

            // Clear the inputs
            this.querySelector('input[name="content"]').value = '';
            this.querySelector('input[name="image"]').value = '';
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      });

        //JavaScript code for handling edit form submission
        document.getElementById('editButton').addEventListener('click', function () {
          // Enable the input fields
          document.getElementById('bioInput').disabled = false;
          document.getElementById('birthdayInput').disabled = false;

          // Show the Save button and hide the Edit button
          document.getElementById('saveButton').style.display = 'block';
          this.style.display = 'none';
        });

        document.getElementById('saveButton').addEventListener('click', function () {
            // Disable the input fields
            document.getElementById('bioInput').disabled = true;
            document.getElementById('birthdayInput').disabled = true;

            // Show the Edit button and hide the Save button
            document.getElementById('editButton').style.display = 'block';
            this.style.display = 'none';

            // Handle saving the data (e.g., make a POST request to the server)
            const bio = document.getElementById('bioInput').value;
            const birthday = document.getElementById('birthdayInput').value;

            fetch("{% url 'edit_profile' %}", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}',
              },
              body: `bio=${encodeURIComponent(bio)}&birthday=${encodeURIComponent(birthday)}`,
            })
              .then(response => response.json())
              .then(data => {
                console.log(data);
                alert('Profile updated successfully!');
              })
              .catch(error => console.error('Error:', error));
          });


    </script>
  </body>
</html>
